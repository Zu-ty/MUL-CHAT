<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MUL-CONNECT - Chat</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='chat.css') }}">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
</head>
<body>

  <!-- Header -->
  <header class="chat-header">
    <img src="{{ url_for('static', filename='images.jpeg') }}" alt="Banner" class="header-img">
    <div class="profile-container">
      {% if session.get('username') %}
        <div class="avatar" onclick="window.location.href='{{ url_for('profile') }}'">
          {% if session.get('profile_pic') %}
            <img src="{{ url_for('uploaded_file', filename=session['profile_pic']) }}" alt="Profile Pic">
          {% else %}
            <span>{{ session['username'][0].upper() }}</span>
          {% endif %}
        </div>
        <span class="username">{{ session['username'] }}</span>
      {% endif %}
      <a href="{{ url_for('logout') }}" class="logout">Logout</a>
    </div>
  </header>

  <!-- Chat Messages -->
  <main class="chat-main" id="chat-main">
    {% for msg in messages %}
      <div class="message">
        <div class="sender-avatar">
          {% if msg['profile_pic'] %}
            <img src="{{ url_for('uploaded_file', filename=msg['profile_pic']) }}">
          {% else %}
            <span>{{ (msg['username'] or '?')[0].upper() }}</span>
          {% endif %}
        </div>
        <div class="message-content">
          <span class="sender-name">{{ msg['username'] or 'Unknown' }}</span>
          {% if msg['content'] %}
            <p>{{ msg['content'] }}</p>
          {% endif %}
          {% if msg['file_path'] %}
            <a href="{{ url_for('uploaded_file', filename=msg['file_path']) }}" target="_blank" class="file-link">
              {{ msg['file_path'] }}
            </a>
          {% endif %}
          <span class="timestamp">{{ msg['timestamp'] }}</span>
        </div>
      </div>
    {% endfor %}
  </main>

  <!-- Message Input -->
  <form id="chat-form" class="chat-form" enctype="multipart/form-data">
    <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off" required>
    <input type="file" id="file-input" name="file">
    <button type="submit">Send</button>
  </form>

  <script>
    /* ðŸ”¥ SOCKET FIX STARTS HERE */
    const socket = io({
      transports: ["websocket"],
      reconnection: true,
      reconnectionAttempts: 10,
      reconnectionDelay: 1000
    });

    const chatId = "{{ chat_id }}";

    // Always rejoin room after reconnect (Render sleep fix)
    socket.on("connect", () => {
      socket.emit("join", { chat_id: chatId });
    });
    /* ðŸ”¥ SOCKET FIX ENDS HERE */

    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const chatMain = document.getElementById('chat-main');
    const fileInput = document.getElementById('file-input');

    chatMain.scrollTop = chatMain.scrollHeight;

    chatForm.addEventListener('submit', function(e) {
      e.preventDefault();

      const content = messageInput.value.trim();
      const file = fileInput.files[0];
      if (!content && !file) return;

      const formData = new FormData();
      formData.append('chat_id', chatId);
      if (file) formData.append('file', file);

      if (file) {
        fetch('/upload', { method: 'POST', body: formData })
          .then(() => fileInput.value = '');
      }

      if (content) {
        socket.emit('send_message', { chat_id: chatId, content });
        messageInput.value = '';
      }
    });

    socket.on('receive_message', function(data) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message';

      const avatarDiv = document.createElement('div');
      avatarDiv.className = 'sender-avatar';
      avatarDiv.innerHTML = data.profile_pic
        ? `<img src="/uploads/${data.profile_pic}">`
        : `<span>${(data.sender || '?')[0].toUpperCase()}</span>`;

      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      contentDiv.innerHTML = `
        <span class="sender-name">${data.sender || 'Unknown'}</span>
        ${data.content ? `<p>${data.content}</p>` : ''}
        <span class="timestamp">${data.timestamp}</span>
      `;

      msgDiv.appendChild(avatarDiv);
      msgDiv.appendChild(contentDiv);
      chatMain.appendChild(msgDiv);
      chatMain.scrollTop = chatMain.scrollHeight;
    });

    messageInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        chatForm.dispatchEvent(new Event('submit'));
      }
    });
  </script>

</body>
</html>
