<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MUL-CONNECT - Chat</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='chat.css') }}">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
</head>
<body>
  <!-- Header -->
  <header class="chat-header">
    <img src="{{ url_for('static', filename='images.jpeg') }}" alt="Banner" class="header-img">
    <div class="profile-container">
      {% if session.get('username') %}
        <div class="avatar" onclick="window.location.href='{{ url_for('profile') }}'">
          {% if session.get('profile_pic') %}
            <img src="{{ url_for('uploaded_file', filename=session['profile_pic']) }}" alt="Profile Pic">
          {% else %}
            <span>{{ (session['username'] or '?')[0].upper() }}</span>
          {% endif %}
        </div>
        <span class="username">{{ session['username'] }}</span>
      {% endif %}
      <a href="{{ url_for('logout') }}" class="logout">Logout</a>
    </div>
  </header>

  <!-- Chat Messages -->
  <main class="chat-main" id="chat-main">
    {% for msg in messages %}
      <div class="message">
        <div class="sender-avatar">
          {% if msg['profile_pic'] %}
            <img src="{{ url_for('uploaded_file', filename=msg['profile_pic']) }}" alt="Profile Pic">
          {% else %}
            <span>{{ (msg['username'] or msg['email'] or '?')[0].upper() }}</span>
          {% endif %}
        </div>
        <div class="message-content">
          <span class="sender-name">{{ msg['username'] or msg['email'] or '?' }}</span>
          {% if msg['content'] %}
            <p>{{ msg['content'] }}</p>
          {% endif %}
          {% if msg['file_path'] %}
            <a href="{{ url_for('uploaded_file', filename=msg['file_path']) }}" target="_blank" class="file-link">{{ msg['file_path'] }}</a>
          {% endif %}
          <span class="timestamp">{{ msg['timestamp'] }}</span>
        </div>
      </div>
    {% endfor %}
  </main>

  <!-- Message Input -->
  <form id="chat-form" class="chat-form" enctype="multipart/form-data">
    <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off" required>
    <input type="file" id="file-input" name="file">
    <button type="submit">Send</button>
  </form>

  <script>
    const socket = io();
    const chatId = "{{ chat_id }}";

    // Join the room
    socket.emit('join', { chat_id: chatId });

    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const chatMain = document.getElementById('chat-main');
    const fileInput = document.getElementById('file-input');

    // Handle message submission
    chatForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const content = messageInput.value.trim();
      const file = fileInput.files[0];
      if (!content && !file) return;

      const formData = new FormData();
      formData.append('chat_id', chatId);
      if (file) formData.append('file', file);

      // Send file to backend
      fetch('/upload', { method: 'POST', body: formData }).then(() => {
        messageInput.value = '';
        fileInput.value = '';
      });

      // Send text message via Socket.IO
      if (content) {
        socket.emit('send_message', { chat_id: chatId, content: content });
        messageInput.value = '';
      }
    });

    // Receive messages
    socket.on('receive_message', function(data) {
      const msgDiv = document.createElement('div');
      msgDiv.classList.add('message');

      const avatarDiv = document.createElement('div');
      avatarDiv.classList.add('sender-avatar');
      if (data.profile_pic) {
        avatarDiv.innerHTML = `<img src="/uploads/${data.profile_pic}" alt="Profile Pic">`;
      } else {
        avatarDiv.innerHTML = `<span>${(data.sender || '?')[0].toUpperCase()}</span>`;
      }

      const contentDiv = document.createElement('div');
      contentDiv.classList.add('message-content');
      let html = `<span class="sender-name">${data.sender || '?'}</span>`;
      if (data.content) html += `<p>${data.content}</p>`;
      if (data.file_path) html += `<a href="/uploads/${data.file_path}" target="_blank" class="file-link">${data.file_path}</a>`;
      html += `<span class="timestamp">${data.timestamp}</span>`;
      contentDiv.innerHTML = html;

      msgDiv.appendChild(avatarDiv);
      msgDiv.appendChild(contentDiv);
      chatMain.appendChild(msgDiv);

      // Scroll to bottom
      chatMain.scrollTop = chatMain.scrollHeight;
    });

    // Enter key to send message
    messageInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        chatForm.dispatchEvent(new Event('submit'));
      }
    });
  </script>
</body>
</html>
